{%- set template_joiner  = joiner(",") -%}
{%- set new_nodes_json_query = '[?cluster_name == `' ~ _cluster.name ~ '`].hosts[]' -%}
{%- set new_nodes = nodes_addition_hosts | json_query(new_nodes_json_query) -%}
{
  "items": [
    {%- for (template_name, role_mapping) in _cluster.host_templates.items() -%}
    {%- if groups['host_template_' ~ template_name] | intersect(new_nodes) | length > 0 -%}
    {%- set role_config_group_refs = [] -%}
    {%- set filtered_services = [] -%}

    {%- for (service, roles) in role_mapping.items() -%}
      {%- set service_ref = service | lower -%}
      {%- if (_cluster.security.kerberos | default(false) and service == "HUE"
            and "HUE_SERVER" in roles and not "KT_RENEWER" in roles) -%}
        {{ roles.append("KT_RENEWER") }}
      {%- endif -%}
      {%- for role in roles -%}
        {%- set (role_type, config_group) = role | cloudera.cluster.extract_role_and_group -%}
        {{ role_config_group_refs.append("{}-{}-{}".format(service_ref, role_type, config_group)) }}
      {%- endfor -%}
  {%- endfor -%}
  {%- if role_config_group_refs -%}
  {{ template_joiner() }}

    {
      "name": "{{ nodes_addition_host_templates_prefix }}{{ template_name }}",
      "clusterRef": {
        "clusterName": "{{ _cluster.name }}",
        "displayName": "{{ _cluster.name }}"
      },
      "roleConfigGroupRefs": [
    {%- set rcg_sep = joiner(",") -%}
      {%- for rcg in role_config_group_refs -%}
        {{ rcg_sep() }}
        {
          "roleConfigGroupName": "{{ rcg }}"
        }
      {%- endfor -%}
  {%- endif -%}

      ]
    }
    {%- endif -%}
    {%- endfor -%}

  ]
}
